<div class="schedule-layout">
  <header class="topbar">
    <div class="brand">
      <mat-icon>event_available</mat-icon>
      <span>AgendaFacil</span>
    </div>

    <nav class="top-nav" aria-label="Navegacao principal">
      <a class="nav-link" routerLink="/dashboard">
        <mat-icon>dashboard</mat-icon>
        Dashboard
      </a>
      <a class="nav-link" routerLink="/services">
        <mat-icon>work_outline</mat-icon>
        Servicos
      </a>
      <a class="nav-link active" routerLink="/schedule">
        <mat-icon>checklist</mat-icon>
        Agendamentos
      </a>
      <a class="nav-link" routerLink="/account">
        <mat-icon>person_outline</mat-icon>
        Conta
      </a>
    </nav>

    <div class="user-area">
      <div class="user-meta">
        <strong>{{ (user$ | async)?.name || 'Administrador' }}</strong>
        <span>{{ (user$ | async)?.email || 'admin@exemplo.com' }}</span>
      </div>
      <button class="logout-button" mat-stroked-button (click)="logout()">
        <mat-icon>logout</mat-icon>
        Sair
      </button>
    </div>
  </header>

  @if (loading$ | async) {
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }

  <main class="main-content">
    <section class="page-hero">
      <div>
        <h1>Meus Agendamentos</h1>
        <p>Gerencie seus agendamentos e pagamentos</p>
      </div>
      <button class="new-booking-button" mat-flat-button routerLink="/services">
        <mat-icon>add</mat-icon>
        Novo Agendamento
      </button>
    </section>

    <section class="summary-grid">
      @if (kanbanSummary$ | async; as summary) {
        <mat-card class="summary-card">
          <p>Ativos</p>
          <strong>{{ summary.activeCount }}</strong>
        </mat-card>
        <mat-card class="summary-card">
          <p>Concluidos</p>
          <strong>{{ summary.concludedCount }}</strong>
        </mat-card>
        <mat-card class="summary-card">
          <p>Cancelados</p>
          <strong>{{ summary.cancelledCount }}</strong>
        </mat-card>
        <mat-card class="summary-card">
          <p>Receita (ativos + concluidos)</p>
          <strong>{{ summary.projectedRevenue | currency: 'BRL' }}</strong>
        </mat-card>
      }
    </section>

    <section class="kanban-board">
      @if (kanbanColumns$ | async; as columns) {
        @for (column of columns; track column.id) {
          <mat-card class="kanban-column" [class.column-active]="column.id === 'ativos'" [class.column-done]="column.id === 'concluidos'" [class.column-cancelled]="column.id === 'cancelados'">
            <header class="column-header">
              <h3>{{ column.title }}</h3>
              <span class="column-count">{{ column.bookings.length }}</span>
            </header>

            <p class="column-total">Total: {{ column.totalAmount | currency: 'BRL' }}</p>

            @if (column.bookings.length === 0) {
              <p class="empty">{{ column.emptyMessage }}</p>
            } @else {
              <ul class="kanban-list">
                @for (booking of column.bookings; track booking.id) {
                  <li class="booking-card">
                    <div class="card-top">
                      <strong>{{ booking.clientName }}</strong>
                      <span>{{ booking.startAt | date: 'dd/MM HH:mm' }}</span>
                    </div>
                    <div class="card-main">
                      <span>{{ booking.serviceName }}</span>
                      <span>Valor: {{ booking.amount | currency: 'BRL' }}</span>
                      @if (booking.paymentTransactionId) {
                        <span>Transacao: {{ booking.paymentTransactionId }}</span>
                      }
                      @if (booking.status === 'cancelled' && booking.cancelledAt) {
                        <span>Cancelado em: {{ booking.cancelledAt | date: 'dd/MM HH:mm' }}</span>
                      }
                    </div>
                    @if (column.id === 'ativos') {
                      <button
                        mat-button
                        color="warn"
                        [disabled]="!canCancel(booking)"
                        (click)="cancelBooking(booking.id)"
                      >
                        Cancelar
                      </button>
                    }
                  </li>
                }
              </ul>
            }
          </mat-card>
        }
      }
    </section>
  </main>
</div>
